<!DOCTYPE HTML>
<script>
var REFRESH_INTERVAL = 10 * 1000; // 10 seconds
var HTTP_REFRESH_INTERVAL = 90;   // 10 seconds * 90 = 15 minutes
var WINDOW = safari.application.openBrowserWindow();
var SSL = false;
var URLEXP = /^http:\/\/(?:www\.)?theoldreader\.com/

var refreshTimeout;
var refreshCounter = 0;

// initialize button click event
safari.application.addEventListener("command", function() {
  findOurTab(function(tab) {
    if(!tab || safari.extension.toolbarItems[0].badge == 0) {
      getCountersFromHTTP();
    }
  });

  openOurTab();
}, false);

// run counter refresh
safari.application.addEventListener("validate", function() {
  findOurTab(function(tab) {
    if(!tab || !refreshTimeout) {
      getCountersFromHTTP();
    }
  });
}, false);

function findOurTab(callback) {
  if (!safari.application.activeBrowserWindow) {
    return callback(false);    
  }
  
  var foundTab, windowTabs = safari.application.activeBrowserWindow.tabs;
  for (var i=0; i<windowTabs.length; i++) {
      if (windowTabs[i].url && windowTabs[i].url.match(URLEXP)) {
          foundTab = windowTabs[i];
      }
  }

  callback(foundTab);
}

function openOurTab() {
  findOurTab(function(tab) {
    if (tab) {
      tab.url = (SSL ? 'https' : 'http') + "://theoldreader.com/";
      tab.activate();
    } else {
      if (safari.application.activeBrowserWindow.activeTab.url) {
          var newTab = safari.application.activeBrowserWindow.openTab();
          newTab.url = (SSL ? 'https' : 'http') + "://theoldreader.com/";
      } else {
          safari.application.activeBrowserWindow.activeTab.url = (SSL ? 'https' : 'http') + "://theoldreader.com/";
      }
    }
  });
}

function reportError() {
  var buttons = safari.extension.toolbarItems;
  for (var i=0; i<buttons.length; i++) {
    buttons[i].badge = 0;
    buttons[i].toolTip = "An error occurred. You may not be logged in.";
  }
}

function updateIcon(count) {
  countInt = parseInt(count)
  if (countInt == 0) {
    count = "" 
  } else {
    count = countInt.toString()
  }
  var buttons = safari.extension.toolbarItems;
  for (var i=0; i<buttons.length; i++) {
    buttons[i].badge = count;
    buttons[i].toolTip = "The Old Reader";
  }
}

function parseCounters(feedData) {
  var unread_count = 0;

  var i, folder;
  for (i=0; folder=feedData.feeds[i]; i++) {
    var k, feed;
    for (k=0; feed=folder.feeds[k]; k++) {
      if (feed.unread_count) {
        unread_count += feed.unread_count;
      }
    }
  }
  for (i=0; folder=feedData.following[i]; i++) {
    if (folder.unread_count) {
      unread_count += folder.unread_count;
    }
  }
  updateIcon(unread_count)
}

function getCounters() {
  if (refreshTimeout) { window.clearInterval(refreshTimeout) }
  refreshCounter++;

  findOurTab(function(tab) {
    var count;
    if (tab && tab.title) {
      var match = /^The Old Reader \((\d+)\)$/.exec(tab.title);
      if (match && match[1]) {
        count = match[1];
      }
    }
    if (count) {
      console.log("Found counter in our tab (" + count + "), no need to fetch counters via http");
      refreshCounter = HTTP_REFRESH_INTERVAL; // trigger HTTP-based refresh as soon as theoldreader tab is closed
      updateIcon(count);
      scheduleRefresh();
    } else {
      if (refreshCounter >= HTTP_REFRESH_INTERVAL) {
        refreshCounter = 0;
        getCountersFromHTTP();
      } else {
        scheduleRefresh();
      }
    }
  });
}

function getCountersFromHTTP() {
  // If request times out or if we get unexpected output, report error and reschedule
  function refreshFailed() {
    window.clearTimeout(requestTimeout);
    reportError();
    scheduleRefresh();
  }

  // If request succeeds, update counters and reschedule
  function refreshSucceeded(feedData) {
    parseCounters(feedData);
    scheduleRefresh();
  }

  var httpRequest = new XMLHttpRequest();
  var requestTimeout = window.setTimeout(function() {
    httpRequest.abort();
    reportError();
    scheduleRefresh();
  }, 20000);

  httpRequest.onerror = function(err) {
    console.log(err);
    refreshFailed();
  }

  httpRequest.onreadystatechange = function() {
    if (httpRequest.readyState == 4) {
      if (httpRequest.status >= 400) {
        console.log('Got HTTP error: ' + httpRequest.status + ' (' + httpRequest.statusText + ')');
        refreshFailed();
      } else if (httpRequest.responseText) {
        window.clearTimeout(requestTimeout);
        var feedData;
        try {
          feedData = JSON.parse(httpRequest.responseText);
          if (feedData.error) {
            refreshFailed();
          } else {
            refreshSucceeded(feedData);            
          }
        } catch (exception) {
          console.log('Exception while parsing json: ' + exception);
          refreshFailed();
        }
      } else {
        console.log('Got nothing!');
        refreshFailed();
      }
    }
  }

  try {
    httpRequest.open('GET', 'http://theoldreader.com/feeds/counts.json', true);
    httpRequest.send(null);
  } catch (exception) {
    console.log('Exception while fetching data: ' + exception);
    refreshFailed();
  }
}

function scheduleRefresh(interval) {
  refreshTimeout = window.setTimeout(getCounters, REFRESH_INTERVAL);
}
</script>